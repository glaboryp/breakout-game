
<!DOCTYPE html>
<html lang="es">

<head>
  <title>Breakout en JavaScript</title>

  <style>
    body {
      background-color: #f0f0f0;
      display: flex;
      place-content: center;
    }

    canvas {
      border: 4px solid #000;
      border-bottom: transparent;
      background: url('./public/bkg.png') repeat;
      margin: 0 auto;
      display: block;
      box-shadow: 0px 0px 20px 0px rgba(0, 0, 0, 0.4);
    }

    .oculto {
      display: none;
    }

    .boton{
      margin-top: 50px;
      padding: 20px;
      width: 50%;
      font-size: x-large;
    }

    .dialogAyuda{
      border-radius: 10px;
      padding: 30px;
      background-color: #f0f0f0;
      font-family: sans-serif;
      font-size: 20px;
      font-weight: bold;
      max-width: 300px;
    }

    .paginaIncio{
      position: absolute;
      margin: 0 auto;
      display: block;
    }

    .imagenes{
      margin-top: 70px;
      justify-items: center;
      text-align: center;
    }

    .botones{
      justify-items: center;
      text-align: center;
      display: grid;
    }
  </style>
</head>
<body>
  <div class="paginaIncio">
    <div class="imagenes">
      <img id="logo" src="./public/logo.png" alt="Logo Breakout" />
    </div>
    <div class="botones">
      <button class="boton" id="botonJugar" onclick="empezar()">Jugar</button>
      <button class="boton" id="botonAyuda" onclick="ayuda()">Ayuda</button>
    </div>
  </div>

  <canvas id="canvas"></canvas>

  <img hidden id="sprite" src="./public/sprite.png" alt="Sprite Arkanoid" />
  <img hidden id="ladrillos" src="./public/sprites.png" alt="Sprite Breakout Atari" />

  <dialog id="dialog" class="dialogAyuda">
    <button aria-label="close" onclick="cerrarAyuda()">X</button>
    <h2>Cómo jugar</h2>
    <p>Utilice las flechas del teclado para moverse a izquierda y derecha</p>
  </dialog>

  <script>
    const canvas = document.querySelector('canvas')
    const ctx = canvas.getContext('2d')

    const $sprite = document.querySelector('#sprite')
    const $ladrillos = document.querySelector('#ladrillos')

    canvas.width = 710
    canvas.height = 590

    /* Variables de nuestro juego */
    let vidas = 5
    let nivelElegido = 1

    /* VARIABLES DE LA PELOTA */
    const radioPelota = 3;
    // posicion de la pelota
    let x = canvas.width / 2
    let y = canvas.height - 30
    // velocidad de la pelota
    let dx = -3
    let dy = -3

    /* VARIABLES DE LA RAQUETA */
    const SENSIBILIDIDAD_RAQUETA = 8

    const alturaRaqueta = 10;
    const anchoRaqueta = 50; // 50

    let raquetaX = (canvas.width - anchoRaqueta) / 2
    let raquetaY = canvas.height - alturaRaqueta - 10

    let derechoPresionado = false
    let izquierdoPresionado = false

    /* VARIABLES DE LOS LADRILLOS */
    const filasLadrillos = 9;
    const columnasLadrillos = 13;
    const anchoLadrillo = 54;
    const altoLadrillo = 22;
    const distanciaEntreLadrillos = 0;
    const distanciaLadrillosTop = 40;
    const distanciaLadrillosIzq = 4;
    const ladrillos = [];

    const BRICK_STATUS = {
      ACTIVE: 1,
      DESTROYED: 0
    }

    for (let c = 0; c < columnasLadrillos; c++) {
      ladrillos[c] = [] // inicializamos con un array vacio
      for (let r = 0; r < filasLadrillos; r++) {
        // calculamos la posicion del ladrillo en la pantalla
        const brickX = c * (anchoLadrillo + distanciaEntreLadrillos) + distanciaLadrillosIzq
        const brickY = r * (altoLadrillo + distanciaEntreLadrillos) + distanciaLadrillosTop
        // Asignar un color a cada ladrillo (depende del nivel en el que estemos)
        let colorNivel = colorLadrillo (r, c)

        // Guardamos la información de cada ladrillo
        ladrillos[c][r] = {
          x: brickX,
          y: brickY,
          status: BRICK_STATUS.ACTIVE,
          color: colorNivel
        }
      }
    }

    function colorLadrillo(r, c) {
      switch (nivelElegido) {
        case 1:
          let color = 1
          if (r === 0 || r === 8 || c === 6) color = 2
          if (
            r === 1 && c < 4 && c > 2 ||
            r === 2 && c < 4 && c > 1 ||
            r === 3 && c < 6 && c > 0 ||
            r === 4 && c < 6 ||
            r === 5 && c < 6 && c > 0 ||
            r === 6 && c < 4 && c > 1 ||
            r === 7 && c < 4 && c > 2
          ) color = 3
          if (
            r === 1 && c > 8 && c < 10 ||
            r === 2 && c > 8 && c < 11 ||
            r === 3 && c > 6 && c < 12 ||
            r === 4 && c > 6 ||
            r === 5 && c > 6 && c < 12 ||
            r === 6 && c > 8 && c < 11 ||
            r === 7 && c > 8 && c < 10
          ) color = 4

          return color
      }
    }

    function drawBall() {
      ctx.beginPath() // iniciar el trazado
      ctx.arc(x, y, radioPelota, 0, Math.PI * 2)
      ctx.fillStyle = '#fff'
      ctx.fill()
      ctx.closePath() // terminar el trazado
    }

    function drawraqueta() {
      ctx.drawImage(
        $sprite, // imagen
        29, // clipX: coordenadas de recorte
        174, // clipY: coordenadas de recorte
        anchoRaqueta, // el tamaño del recorte
        alturaRaqueta, // tamaño del recorte
        raquetaX, // posición X del dibujo
        raquetaY, // posición Y del dibujo
        anchoRaqueta, // ancho del dibujo
        alturaRaqueta // alto del dibujo
      )
    }

    function drawBricks() {
      for (let c = 0; c < columnasLadrillos; c++) {
        for (let r = 0; r < filasLadrillos; r++) {
          const currentBrick = ladrillos[c][r]
          if (currentBrick.status === BRICK_STATUS.DESTROYED) continue;

          const clipX = 324 + currentBrick.color * 54

          ctx.drawImage(
            $ladrillos,
            clipX,
            22,
            anchoLadrillo, // 31
            altoLadrillo, // 14
            currentBrick.x,
            currentBrick.y,
            anchoLadrillo,
            altoLadrillo
          )
        }
      }
    }

    function drawUI() {
      ctx.fillText(`FPS: ${framesPerSec}`, 5, 10)
    }

    function collisionDetection() {
      for (let c = 0; c < columnasLadrillos; c++) {
        for (let r = 0; r < filasLadrillos; r++) {
          const currentBrick = ladrillos[c][r]
          if (currentBrick.status === BRICK_STATUS.DESTROYED) continue;

          const isBallSameXAsBrick =
            x > currentBrick.x &&
            x < currentBrick.x + anchoLadrillo

          const isBallSameYAsBrick =
            y > currentBrick.y &&
            y < currentBrick.y + altoLadrillo

          if (isBallSameXAsBrick && isBallSameYAsBrick) {
            dy = -dy
            currentBrick.status = BRICK_STATUS.DESTROYED
          }
        }
      }
    }

    function ballMovement() {
      // rebotar las pelotas en los laterales
      if (
        x + dx > canvas.width - radioPelota || // la pared derecha
        x + dx < radioPelota // la pared izquierda
      ) {
        dx = -dx
      }

      // rebotar en la parte de arriba
      if (y + dy < radioPelota) {
        dy = -dy
      }

      // la pelota toca la pala
      const isBallSameXAsraqueta =
        x > raquetaX &&
        x < raquetaX + anchoRaqueta

      const isBallTouchingraqueta =
        y + dy > raquetaY

      if (isBallSameXAsraqueta && isBallTouchingraqueta) {
        dy = -dy // cambiamos la dirección de la pelota
      } else if ( // la pelota toca el suelo
        y + dy > canvas.height - radioPelota || y + dy > raquetaY + alturaRaqueta
      ) {
        document.location.reload()
      }

      // mover la pelota
      x += dx
      y += dy
    }

    function raquetaMovement() {
      if (derechoPresionado && raquetaX < canvas.width - anchoRaqueta) {
        raquetaX += SENSIBILIDIDAD_RAQUETA
      } else if (izquierdoPresionado && raquetaX > 0) {
        raquetaX -= SENSIBILIDIDAD_RAQUETA
      }
    }

    function cleanCanvas() {
      ctx.clearRect(0, 0, canvas.width, canvas.height)
    }

    function initEvents() {
      document.addEventListener('keydown', keyDownHandler)
      document.addEventListener('keyup', keyUpHandler)

      function keyDownHandler(event) {
        const { key } = event
        if (key === 'Right' || key === 'ArrowRight' || key.toLowerCase() === 'd') {
          derechoPresionado = true
        } else if (key === 'Left' || key === 'ArrowLeft' || key.toLowerCase() === 'a') {
          izquierdoPresionado = true
        }
      }

      function keyUpHandler(event) {
        const { key } = event
        if (key === 'Right' || key === 'ArrowRight' || key.toLowerCase() === 'd') {
          derechoPresionado = false
        } else if (key === 'Left' || key === 'ArrowLeft' || key.toLowerCase() === 'a') {
          izquierdoPresionado = false
        }
      }
    }

    // velocidad de fps que queremos que renderice el juego
    const fps = 60
    
    let msPrev = window.performance.now()
    let msFPSPrev = window.performance.now() + 1000;
    const msPerFrame = 1000 / fps
    let frames = 0
    let framesPerSec = fps;

    function draw() {
        window.requestAnimationFrame(draw)

        const msNow = window.performance.now()
        const msPassed = msNow - msPrev

        if (msPassed < msPerFrame) return

        const excessTime = msPassed % msPerFrame
        msPrev = msNow - excessTime

        frames++

        if (msFPSPrev < msNow)
        {
          msFPSPrev = window.performance.now() + 1000
          framesPerSec = frames;
          frames = 0;
        }

        // ... render code
        cleanCanvas()
        // hay que dibujar los elementos
        drawBall()
        drawraqueta()
        drawBricks()
        drawUI()

        // colisiones y movimientos
        collisionDetection()
        ballMovement()
        raquetaMovement()
    }

    function empezar() {
      document.getElementById("botonJugar").classList.toggle("oculto");
      document.getElementById("botonAyuda").classList.toggle("oculto");
      document.getElementById("logo").classList.toggle("oculto");
      draw()
      initEvents()
    }

    function ayuda() {
      const dialog = document.getElementById('dialog');
      dialog.showModal();
    }

    function cerrarAyuda() {
      const dialog = document.getElementById('dialog');
      dialog.close();
    }
  </script>
</body>
</html>