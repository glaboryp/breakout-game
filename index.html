
<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">

    <title>Breakout en JavaScript</title>
    <meta name="description" content="Clon del mítico juego de Atari Breakout">

    <!-- OPEN GRAPH -->
		<meta property="og:title" content="Juego Breakout en JavaScript">
		<meta property="og:description" content="Clon del mítico juego de Atari Breakout">
		<meta property="og:image" content="/assets/logo.png">
		<meta property="og:image:alt" content="Logo del juego Breakout">

		<meta name="robots" content="index, follow">
		<link rel="icon" type="image/png" href="/assets/logoCuadrado.png">

    <style>
      body {
        background-color: #f0f0f0;
        font-family: system-ui, -apple-system,"Helvetica Neue", Helvetica, Arial, sans-serif;
        display: flex;
        place-content: center;
      }

      canvas {
        border: 4px solid #3b110f;
        border-bottom: transparent;
        background: #f3ccb5;
        margin: 0 auto;
        box-shadow: 0px 0px 20px 0px 	rgb(110 40 32 / 0.4);
      }

      .paginaInicio{
        position: absolute;
        height: 90vh;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        gap: 2em;
      }

      .boton {
        font-size: x-large;
        letter-spacing: 5px;
        text-transform: uppercase;
        color: #3b110f;
        cursor: pointer;
        border: 3px solid;
        padding: 0.5em 0.5em;
        box-shadow: 1px 1px 0px 0px, 2px 2px 0px 0px, 3px 3px 0px 0px, 4px 4px 0px 0px, 5px 5px 0px 0px;
        transition-duration: 200ms;
        transition-timing-function: ease-out;
        transition-property: box-shadow;
      }

      .boton:hover, .boton:active {
        box-shadow: 0px 0px 0px 0px;
        top: 5px;
        left: 5px;
        transition-duration: 500ms;
      }

      .botonAccion {
        width: 80%;
      }

      .active {
        box-shadow: 0px 0px 0px 0px;
        top: 5px;
        left: 5px;
        background-color: #3b110f;
        color: #f0f0f0;
      }

      .dialog{
        background-color: #f0f0f0;
        color: #3b110f;
        width: 400px;
        border: solid #3b110f 3px;
        border-radius: 10px;
      }

      .divDialog{
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 30px;
      }

      .numero{
        display: inline-flex;
        width: 18px;
      }

      .ajustes{
        display: flex;
        gap: 5px;
        align-items: center;
      }

      h1{
        margin: 0;
      }

      p{
        font-size: 20px;
        font-weight: bold;
      }

      .oculto {
        display: none;
      }

      .iconContainer {
        position: fixed;
        display: flex;
        top: 20px;
        right: 20px;
      }

      .link{
        transition: all 0.3s linear;
      }

      .link:hover{
        transform: scale(1.1);
      }

      .icono{
        width: 35px;
        height: 35px;
      }

      @media (min-height: 700px) {
        .paginaInicio{
          gap: 3em;
        }
        #logo {
          width: 600px;
        }
      }

      @media (min-height: 500px) and (max-height: 560px) {
        .paginaInicio{
          gap: 1.7em;
        }
        #logo {
          width: 450px;
        }
      }

      @media (max-height: 500px) {
        .paginaInicio{
          gap: 1.4em;
        }
        #logo {
          width: 400px;
        }
      }
    </style>
  </head>
  <body>
    <div class="paginaInicio" id="paginaInicio">
      <img id="logo" src="./assets/logo.png" alt="Logo Breakout" />
      <div id="niveles">
        <button class="boton active" id="1">Nivel 1</button>
        <button class="boton" id="2">Nivel 2</button>
        <button class="boton" id="3">Nivel 3</button>
      </div>
      <button class="boton botonAccion id="botonJugar" onclick="empezar()">Jugar</button>
      <button class="boton botonAccion" id="botonAyuda" onclick="ajustes()">Ajustes</button>
      <button class="boton botonAccion" id="botonAyuda" onclick="ayuda()">Ayuda</button>
    </div>

    <div class="iconContainer">
      <a class="link" href="https://github.com/glaboryp/breakout-game" target="_blank" rel="noopener noreferrer"
      >
        <svg class="icono" fill="#3b110f" viewBox="0 0 24 24">
          <path
            d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"
          >
          </path>
        </svg>
      </a>
    </div>

    <canvas id="canvas"></canvas>

    <img hidden id="sprite" src="./assets/sprite.png" alt="Sprite Breakout Atari" />

    <dialog id="dialogAyuda" class="dialog">
      <div class="divDialog">
        <h1>Cómo jugar</h1>
        <p>Utilice las flechas del teclado para moverse a izquierda y derecha</p>
        <button class="boton" aria-label="Aceptar" onclick="cerrarAyuda()">Aceptar</button>
      </div>
    </dialog>

    <dialog id="dialogAjustes" class="dialog">
      <div class="divDialog">
        <h1>Ajustes</h1>
        <div class="ajustes">
          Velocidad de la raqueta: <span id="rangeVelocidad" class="numero">10</span>
          <input id="velocidadRaqueta" type="range" min="1" max="50" value="10" oninput="rangeVelocidad.innerText = this.value">
        </div>
        <div class="ajustes">
          Tamaño de la pelota: <span id="rangeRadio" class="numero">3</span>
          <input id="radioPelota" type="range" min="1" max="10" value="3" oninput="rangeRadio.innerText = this.value">
        </div>
        <button class="boton" aria-label="Aceptar" onclick="cerrarAjustes()">Aceptar</button>
      </div>
    </dialog>

    <script>

      let botonAnterior = document.getElementsByClassName("active")[0]
      const niveles = document.getElementById("niveles")

      niveles.addEventListener('click',(e) => {
        const esBoton = e.target.nodeName === 'BUTTON'
  
        if (!esBoton) {
          return
        }
        
        e.target.classList.add('active')

        if(botonAnterior !== null && botonAnterior !== e.target) {
          botonAnterior.classList.remove('active')
        }
        
        botonAnterior = e.target
      })

      const canvas = document.querySelector('canvas')
      const ctx = canvas.getContext('2d')

      const $sprite = document.querySelector('#sprite')

      canvas.width = 710
      canvas.height = window.innerHeight - 30 //590

      /* Variables de nuestro juego */
      let vidas = 3
      let nivelElegido = 1

      /* VARIABLES DE LA PELOTA */
      let radioPelota = 3;
      // posicion de la pelota
      let x = canvas.width / 2
      let y = canvas.height - 70
      // velocidad de la pelota
      let dx = -3
      let dy = -3

      /* VARIABLES DE LA RAQUETA */
      let velocidad_raqueta = 10

      const alturaRaqueta = 31;
      const anchoRaqueta = 91;

      let raquetaX = (canvas.width - anchoRaqueta) / 2
      let raquetaY = canvas.height - alturaRaqueta - 10

      let derechoPresionado = false
      let izquierdoPresionado = false

      /* VARIABLES DE LOS LADRILLOS */
      const filasLadrillos = 9;
      const columnasLadrillos = 13;
      const anchoLadrillo = 54;
      const altoLadrillo = 22;
      const distanciaEntreLadrillos = 0;
      const distanciaLadrillosTop = 40;
      const distanciaLadrillosIzq = 4;
      const ladrillos = [];

      const ESTADO_LADRILLO = {
        ACTIVO: 1,
        DESTRUIDO: 0
      }

      function drawBall() {
        ctx.beginPath() // iniciar el trazado
        ctx.arc(x, y, radioPelota, 0, Math.PI * 2)
        ctx.fillStyle = '#3b110f'
        ctx.fill()
        ctx.closePath() // terminar el trazado
      }

      function drawraqueta() {
        ctx.drawImage(
          $sprite, // imagen
          58, // clipX: coordenadas de recorte
          302, // clipY: coordenadas de recorte
          anchoRaqueta, // el tamaño del recorte
          alturaRaqueta, // tamaño del recorte
          raquetaX, // posición X del dibujo
          raquetaY, // posición Y del dibujo
          anchoRaqueta, // ancho del dibujo
          alturaRaqueta // alto del dibujo
        )
      }

      function drawBricks() {
        for (let c = 0; c < columnasLadrillos; c++) {
          for (let r = 0; r < filasLadrillos; r++) {
            const currentBrick = ladrillos[c][r]
            if (currentBrick.status === ESTADO_LADRILLO.DESTRUIDO) continue;

            const clipX = 324 + currentBrick.color * 54

            ctx.drawImage(
              $sprite,
              clipX,
              22,
              anchoLadrillo, // 31
              altoLadrillo, // 14
              currentBrick.x,
              currentBrick.y,
              anchoLadrillo,
              altoLadrillo
            )
          }
        }
      }

      function drawUI() {
        ctx.font = "10px Verdana"
        ctx.fillText(`FPS: ${framesPerSec}`, 5, 10)

        for(var i = 0; i < vidas; i++) {
          ctx.drawImage(
            $sprite, // imagen
            87, // clipX: coordenadas de recorte
            60, // clipY: coordenadas de recorte
            30, // el tamaño del recorte
            30, // tamaño del recorte
            300 + 40*i, // posición X del dibujo
            5, // posición Y del dibujo
            30, // ancho del dibujo
            30 // alto del dibujo
          )
        }
      }

      function collisionDetection() {
        for (let c = 0; c < columnasLadrillos; c++) {
          for (let r = 0; r < filasLadrillos; r++) {
            const currentBrick = ladrillos[c][r]
            if (currentBrick.status === ESTADO_LADRILLO.DESTRUIDO) continue;

            const isBallSameXAsBrick =
              x > currentBrick.x &&
              x < currentBrick.x + anchoLadrillo

            const isBallSameYAsBrick =
              y > currentBrick.y &&
              y < currentBrick.y + altoLadrillo

            if (isBallSameXAsBrick && isBallSameYAsBrick) {
              dy = -dy
              currentBrick.status = ESTADO_LADRILLO.DESTRUIDO
            }
          }
        }
      }

      function ballMovement() {
        // rebotar las pelotas en los laterales
        if (
          x + dx > canvas.width - radioPelota || // la pared derecha
          x + dx < radioPelota // la pared izquierda
        ) {
          dx = -dx
        }

        // rebotar en la parte de arriba
        if (y + dy < radioPelota) {
          dy = -dy
        }

        // la pelota toca la pala
        const isBallSameXAsraqueta =
          x > raquetaX &&
          x < raquetaX + anchoRaqueta

        const isBallTouchingraqueta =
          y + dy > raquetaY

        if (isBallSameXAsraqueta && isBallTouchingraqueta) {
          dy = -dy // cambiamos la dirección de la pelota
        } else if ( // la pelota toca el suelo
          y + dy > canvas.height - radioPelota || y + dy > raquetaY + alturaRaqueta
        ) {
          if(vidas > 1){
            vidas--
            x = canvas.width / 2
            y = canvas.height - 70
            raquetaX = (canvas.width - anchoRaqueta) / 2
            raquetaY = canvas.height - alturaRaqueta - 10
          }else{
            vidas--
            document.location.reload()
          }
        }

        // mover la pelota
        x += dx
        y += dy
      }

      function raquetaMovement() {
        if (derechoPresionado && raquetaX < canvas.width - anchoRaqueta) {
          raquetaX += velocidad_raqueta
        } else if (izquierdoPresionado && raquetaX > 0) {
          raquetaX -= velocidad_raqueta
        }
      }

      function cleanCanvas() {
        ctx.clearRect(0, 0, canvas.width, canvas.height)
      }

      function initEvents() {
        document.addEventListener('keydown', keyDownHandler)
        document.addEventListener('keyup', keyUpHandler)

        function keyDownHandler(event) {
          const { key } = event
          if (key === 'Right' || key === 'ArrowRight' || key.toLowerCase() === 'd') {
            derechoPresionado = true
          } else if (key === 'Left' || key === 'ArrowLeft' || key.toLowerCase() === 'a') {
            izquierdoPresionado = true
          }
        }

        function keyUpHandler(event) {
          const { key } = event
          if (key === 'Right' || key === 'ArrowRight' || key.toLowerCase() === 'd') {
            derechoPresionado = false
          } else if (key === 'Left' || key === 'ArrowLeft' || key.toLowerCase() === 'a') {
            izquierdoPresionado = false
          }
        }
      }

      // velocidad de fps que queremos que renderice el juego
      const fps = 60
      
      let msPrev = window.performance.now()
      let msFPSPrev = window.performance.now() + 1000;
      const msPerFrame = 1000 / fps
      let frames = 0
      let framesPerSec = fps;

      function draw() {
          window.requestAnimationFrame(draw)

          const msNow = window.performance.now()
          const msPassed = msNow - msPrev

          if (msPassed < msPerFrame) return

          const excessTime = msPassed % msPerFrame
          msPrev = msNow - excessTime

          frames++

          if (msFPSPrev < msNow)
          {
            msFPSPrev = window.performance.now() + 1000
            framesPerSec = frames;
            frames = 0;
          }

          // ... render code
          cleanCanvas()
          // hay que dibujar los elementos
          drawBall()
          drawraqueta()
          drawBricks()
          drawUI()

          // colisiones y movimientos
          collisionDetection()
          ballMovement()
          raquetaMovement()
      }

      function empezar() {
        document.getElementById("paginaInicio").classList.toggle("oculto");
        nivelElegido = document.getElementsByClassName("active")[0].id
        radioPelota = document.getElementById("radioPelota").valueAsNumber
        velocidad_raqueta = document.getElementById("velocidadRaqueta").valueAsNumber

        for (let c = 0; c < columnasLadrillos; c++) {
          ladrillos[c] = [] // inicializamos con un array vacio
          for (let r = 0; r < filasLadrillos; r++) {
            // calculamos la posicion del ladrillo en la pantalla
            const brickX = c * (anchoLadrillo + distanciaEntreLadrillos) + distanciaLadrillosIzq
            const brickY = r * (altoLadrillo + distanciaEntreLadrillos) + distanciaLadrillosTop
            // Asignar un color a cada ladrillo (depende del nivel en el que estemos)
            let colorNivel = colorLadrillo (r, c)

            // Guardamos la información de cada ladrillo
            ladrillos[c][r] = {
              x: brickX,
              y: brickY,
              status: ESTADO_LADRILLO.ACTIVO,
              color: colorNivel
            }
          }
        }
        draw()
        initEvents()
      }

      function colorLadrillo(r, c) {
        let color = 1
        switch (nivelElegido) {
          case "1":
            if (r === 0 || r === 8 || c === 6) color = 2
            if (
              r === 1 && c < 4 && c > 2 ||
              r === 2 && c < 4 && c > 1 ||
              r === 3 && c < 6 && c > 0 ||
              r === 4 && c < 6 ||
              r === 5 && c < 6 && c > 0 ||
              r === 6 && c < 4 && c > 1 ||
              r === 7 && c < 4 && c > 2
            ) color = 3
            if (
              r === 1 && c > 8 && c < 10 ||
              r === 2 && c > 8 && c < 11 ||
              r === 3 && c > 6 && c < 12 ||
              r === 4 && c > 6 ||
              r === 5 && c > 6 && c < 12 ||
              r === 6 && c > 8 && c < 11 ||
              r === 7 && c > 8 && c < 10
            ) color = 4
          break
          
          case "2":
            if (
              (c === 1 || c === 11) && r < 6 ||
              c === 6 && r > 2 ||
              c === 7 && r === 3 ||
              c === 8 && r === 2 ||
              c === 9 && r === 1 ||
              c === 10 && r === 0 ||
              c === 7 && r === 8 ||
              c === 8 && r === 7 ||
              c === 9 && r === 6 ||
              c === 10 && r === 5 ||
              c === 5 && r === 3 ||
              c === 4 && r === 2 ||
              c === 3 && r === 1 ||
              c === 2 && r === 0 ||
              c === 5 && r === 8 ||
              c === 4 && r === 7 ||
              c === 3 && r === 6 ||
              c === 2 && r === 5
             ) color = 3
            if (
              c === 10 && r > 0 && r < 5 ||
              c === 9 && r > 1 && r < 6 ||
              c === 8 && r > 2 && r < 7 ||
              c === 7 && r > 3 && r < 8 
            ) color = 4
            if (
              c === 2 && r > 0 && r < 5 ||
              c === 3 && r > 1 && r < 6 ||
              c === 4 && r > 2 && r < 7 ||
              c === 5 && r > 3 && r < 8 
            ) color = 5
          break

          case "3":
            if(
              c === 6 ||
              r === 0 && (c < 2 || c > 10) ||
              r === 8 && c > 3 && c < 9
            ) color = 2
            if(
              r === 2 && (c < 2 || c > 10) ||
              r === 1 && (c > 1 && c < 4 || c > 8 && c < 11) ||
              r === 0 && (c > 3 && c < 6 || c > 6 && c < 9)
            ) color = 3
            if(
              r === 4 && (c < 2 || c > 10) ||
              r === 3 && (c > 1 && c < 4 || c > 8 && c < 11) ||
              r === 2 && (c > 3 && c < 6 || c > 6 && c < 9)
            ) color = 4
            if(
              r === 6 && (c < 2 || c > 10) ||
              r === 5 && (c > 1 && c < 4 || c > 8 && c < 11) ||
              r === 4 && (c > 3 && c < 6 || c > 6 && c < 9)
            ) color = 5
            if(
              r === 8 && (c < 2 || c > 10) ||
              r === 7 && (c > 1 && c < 4 || c > 8 && c < 11) ||
              r === 6 && (c > 3 && c < 6 || c > 6 && c < 9)
            ) color = 6
          break
        }
        return color
      }

      function ayuda() {
        const dialogAyuda = document.getElementById('dialogAyuda');
        dialogAyuda.showModal();
      }

      function cerrarAyuda() {
        const dialogAyuda = document.getElementById('dialogAyuda');
        dialogAyuda.close();
      }

      function ajustes() {
        const dialogAjustes = document.getElementById('dialogAjustes');
        dialogAjustes.showModal();
      }

      function cerrarAjustes() {
        const dialogAjustes = document.getElementById('dialogAjustes');
        dialogAjustes.close();
      }
    </script>
  </body>
</html>