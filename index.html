
<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">

    <title>Breakout en JavaScript</title>
    <meta name="description" content="Clon del mítico juego de Atari Breakout">

    <!-- OPEN GRAPH -->
		<meta property="og:title" content="Juego Breakout en JavaScript">
		<meta property="og:description" content="Clon del mítico juego de Atari Breakout">
		<meta property="og:image" content="/assets/logo.png">
		<meta property="og:image:alt" content="Logo del juego Breakout">

		<meta name="robots" content="index, follow">
		<link rel="icon" type="image/png" href="/assets/logoCuadrado.png">

    <style>
      body {
        background-color: #f0f0f0;
        font-family: system-ui, -apple-system,"Helvetica Neue", Helvetica, Arial, sans-serif;
        display: flex;
        place-content: center;
      }

      canvas {
        border: 4px solid #3b110f;
        border-bottom: transparent;
        background: #f3ccb5;
        margin: 0 auto;
        box-shadow: 0px 0px 20px 0px 	rgb(110 40 32 / 0.4);
      }

      .paginaIncio{
        position: absolute;
        padding-top: 70px;
      }

      .botones{
        position: relative;
        justify-items: center;
        text-align: center;
        display: flex;
        flex-direction: column;
        gap: 2em;
        margin-top: 40px;
      }

      .boton {
        font-size: x-large;
        letter-spacing: 5px;
        text-transform: uppercase;
        color: #3b110f;
        cursor: pointer;
        border: 3px solid;
        padding: 0.5em 0.5em;
        box-shadow: 1px 1px 0px 0px, 2px 2px 0px 0px, 3px 3px 0px 0px, 4px 4px 0px 0px, 5px 5px 0px 0px;
        position: relative;
      }

      .boton:hover, .boton:active {
        box-shadow: 0px 0px 0px 0px;
        top: 5px;
        left: 5px;
      }

      .dialogAyuda{
        background-color: #f0f0f0;
        color: #3b110f;
        max-width: 40%;
        border: solid #3b110f 3px;
        border-radius: 10px;
      }

      .ayuda{
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      p{
        font-size: 20px;
        font-weight: bold;
        margin-bottom: 40px;
      }

      .oculto {
        display: none;
      }
    </style>
  </head>
  <body>
    <div class="paginaIncio">
      <img id="logo" src="./assets/logo.png" alt="Logo Breakout" />
      <div class="botones">
        <button class="boton" id="botonJugar" onclick="empezar()">Jugar</button>
        <button class="boton" id="botonAyuda" onclick="ayuda()">Ayuda</button>
      </div>
    </div>

    <canvas id="canvas"></canvas>

    <img hidden id="sprite" src="./assets/sprite.png" alt="Sprite Breakout Atari" />

    <dialog id="dialog" class="dialogAyuda">
      <div class="ayuda">
        <h1>Cómo jugar</h1>
        <p>Utilice las flechas del teclado para moverse a izquierda y derecha</p>
        <button class="boton" aria-label="Aceptar" onclick="cerrarAyuda()">Aceptar</button>
      </div>
    </dialog>

    <script>
      const canvas = document.querySelector('canvas')
      const ctx = canvas.getContext('2d')

      const $sprite = document.querySelector('#sprite')

      canvas.width = 710
      canvas.height = 590

      /* Variables de nuestro juego */
      let vidas = 5
      let nivelElegido = 1

      /* VARIABLES DE LA PELOTA */
      const radioPelota = 3;
      // posicion de la pelota
      let x = canvas.width / 2
      let y = canvas.height - 60
      // velocidad de la pelota
      let dx = -3
      let dy = -3

      /* VARIABLES DE LA RAQUETA */
      const SENSIBILIDIDAD_RAQUETA = 15

      const alturaRaqueta = 31;
      const anchoRaqueta = 91; // 91

      let raquetaX = (canvas.width - anchoRaqueta) / 2
      let raquetaY = canvas.height - alturaRaqueta - 10

      let derechoPresionado = false
      let izquierdoPresionado = false

      /* VARIABLES DE LOS LADRILLOS */
      const filasLadrillos = 9;
      const columnasLadrillos = 13;
      const anchoLadrillo = 54;
      const altoLadrillo = 22;
      const distanciaEntreLadrillos = 0;
      const distanciaLadrillosTop = 40;
      const distanciaLadrillosIzq = 4;
      const ladrillos = [];

      const BRICK_STATUS = {
        ACTIVE: 1,
        DESTROYED: 0
      }

      for (let c = 0; c < columnasLadrillos; c++) {
        ladrillos[c] = [] // inicializamos con un array vacio
        for (let r = 0; r < filasLadrillos; r++) {
          // calculamos la posicion del ladrillo en la pantalla
          const brickX = c * (anchoLadrillo + distanciaEntreLadrillos) + distanciaLadrillosIzq
          const brickY = r * (altoLadrillo + distanciaEntreLadrillos) + distanciaLadrillosTop
          // Asignar un color a cada ladrillo (depende del nivel en el que estemos)
          let colorNivel = colorLadrillo (r, c)

          // Guardamos la información de cada ladrillo
          ladrillos[c][r] = {
            x: brickX,
            y: brickY,
            status: BRICK_STATUS.ACTIVE,
            color: colorNivel
          }
        }
      }

      function colorLadrillo(r, c) {
        switch (nivelElegido) {
          case 1:
            let color = 1
            if (r === 0 || r === 8 || c === 6) color = 2
            if (
              r === 1 && c < 4 && c > 2 ||
              r === 2 && c < 4 && c > 1 ||
              r === 3 && c < 6 && c > 0 ||
              r === 4 && c < 6 ||
              r === 5 && c < 6 && c > 0 ||
              r === 6 && c < 4 && c > 1 ||
              r === 7 && c < 4 && c > 2
            ) color = 3
            if (
              r === 1 && c > 8 && c < 10 ||
              r === 2 && c > 8 && c < 11 ||
              r === 3 && c > 6 && c < 12 ||
              r === 4 && c > 6 ||
              r === 5 && c > 6 && c < 12 ||
              r === 6 && c > 8 && c < 11 ||
              r === 7 && c > 8 && c < 10
            ) color = 4

            return color
        }
      }

      function drawBall() {
        ctx.beginPath() // iniciar el trazado
        ctx.arc(x, y, radioPelota, 0, Math.PI * 2)
        ctx.fillStyle = '#fff'
        ctx.fill()
        ctx.closePath() // terminar el trazado
      }

      function drawraqueta() {
        ctx.drawImage(
          $sprite, // imagen
          58, // clipX: coordenadas de recorte
          302, // clipY: coordenadas de recorte
          anchoRaqueta, // el tamaño del recorte
          alturaRaqueta, // tamaño del recorte
          raquetaX, // posición X del dibujo
          raquetaY, // posición Y del dibujo
          anchoRaqueta, // ancho del dibujo
          alturaRaqueta // alto del dibujo
        )
      }

      function drawBricks() {
        for (let c = 0; c < columnasLadrillos; c++) {
          for (let r = 0; r < filasLadrillos; r++) {
            const currentBrick = ladrillos[c][r]
            if (currentBrick.status === BRICK_STATUS.DESTROYED) continue;

            const clipX = 324 + currentBrick.color * 54

            ctx.drawImage(
              $sprite,
              clipX,
              22,
              anchoLadrillo, // 31
              altoLadrillo, // 14
              currentBrick.x,
              currentBrick.y,
              anchoLadrillo,
              altoLadrillo
            )
          }
        }
      }

      function drawUI() {
        ctx.fillText(`FPS: ${framesPerSec}`, 5, 10)
      }

      function collisionDetection() {
        for (let c = 0; c < columnasLadrillos; c++) {
          for (let r = 0; r < filasLadrillos; r++) {
            const currentBrick = ladrillos[c][r]
            if (currentBrick.status === BRICK_STATUS.DESTROYED) continue;

            const isBallSameXAsBrick =
              x > currentBrick.x &&
              x < currentBrick.x + anchoLadrillo

            const isBallSameYAsBrick =
              y > currentBrick.y &&
              y < currentBrick.y + altoLadrillo

            if (isBallSameXAsBrick && isBallSameYAsBrick) {
              dy = -dy
              currentBrick.status = BRICK_STATUS.DESTROYED
            }
          }
        }
      }

      function ballMovement() {
        // rebotar las pelotas en los laterales
        if (
          x + dx > canvas.width - radioPelota || // la pared derecha
          x + dx < radioPelota // la pared izquierda
        ) {
          dx = -dx
        }

        // rebotar en la parte de arriba
        if (y + dy < radioPelota) {
          dy = -dy
        }

        // la pelota toca la pala
        const isBallSameXAsraqueta =
          x > raquetaX &&
          x < raquetaX + anchoRaqueta

        const isBallTouchingraqueta =
          y + dy > raquetaY

        if (isBallSameXAsraqueta && isBallTouchingraqueta) {
          dy = -dy // cambiamos la dirección de la pelota
        } else if ( // la pelota toca el suelo
          y + dy > canvas.height - radioPelota || y + dy > raquetaY + alturaRaqueta
        ) {
          document.location.reload()
        }

        // mover la pelota
        x += dx
        y += dy
      }

      function raquetaMovement() {
        if (derechoPresionado && raquetaX < canvas.width - anchoRaqueta) {
          raquetaX += SENSIBILIDIDAD_RAQUETA
        } else if (izquierdoPresionado && raquetaX > 0) {
          raquetaX -= SENSIBILIDIDAD_RAQUETA
        }
      }

      function cleanCanvas() {
        ctx.clearRect(0, 0, canvas.width, canvas.height)
      }

      function initEvents() {
        document.addEventListener('keydown', keyDownHandler)
        document.addEventListener('keyup', keyUpHandler)

        function keyDownHandler(event) {
          const { key } = event
          if (key === 'Right' || key === 'ArrowRight' || key.toLowerCase() === 'd') {
            derechoPresionado = true
          } else if (key === 'Left' || key === 'ArrowLeft' || key.toLowerCase() === 'a') {
            izquierdoPresionado = true
          }
        }

        function keyUpHandler(event) {
          const { key } = event
          if (key === 'Right' || key === 'ArrowRight' || key.toLowerCase() === 'd') {
            derechoPresionado = false
          } else if (key === 'Left' || key === 'ArrowLeft' || key.toLowerCase() === 'a') {
            izquierdoPresionado = false
          }
        }
      }

      // velocidad de fps que queremos que renderice el juego
      const fps = 60
      
      let msPrev = window.performance.now()
      let msFPSPrev = window.performance.now() + 1000;
      const msPerFrame = 1000 / fps
      let frames = 0
      let framesPerSec = fps;

      function draw() {
          window.requestAnimationFrame(draw)

          const msNow = window.performance.now()
          const msPassed = msNow - msPrev

          if (msPassed < msPerFrame) return

          const excessTime = msPassed % msPerFrame
          msPrev = msNow - excessTime

          frames++

          if (msFPSPrev < msNow)
          {
            msFPSPrev = window.performance.now() + 1000
            framesPerSec = frames;
            frames = 0;
          }

          // ... render code
          cleanCanvas()
          // hay que dibujar los elementos
          drawBall()
          drawraqueta()
          drawBricks()
          drawUI()

          // colisiones y movimientos
          collisionDetection()
          ballMovement()
          raquetaMovement()
      }

      function empezar() {
        document.getElementById("botonJugar").classList.toggle("oculto");
        document.getElementById("botonAyuda").classList.toggle("oculto");
        document.getElementById("logo").classList.toggle("oculto");
        draw()
        initEvents()
      }

      function ayuda() {
        const dialog = document.getElementById('dialog');
        dialog.showModal();
      }

      function cerrarAyuda() {
        const dialog = document.getElementById('dialog');
        dialog.close();
      }
    </script>
  </body>
</html>